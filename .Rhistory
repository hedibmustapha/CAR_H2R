summarize_all(hsm_mode, .data[["type_contact"]])
data$`ig_3_groupop/hote`
data$ig_3_groupop/hote
data$'ig_3_groupop/hote'
data %>% select(`ig_3_groupop/hote`)
names(data)<-gsub("[/]",".",names(data))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data %>% summarise(f = hsm_mode(ig_3_groupop.hote,type_contact))
str(data$ig_3_groupop.hote)
data$info_loc_H2R
View(data)
data$ig_3_groupop.hote
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data %>% filter(info_prefecture_H2R = "haute_kotto", info_sous_prefecture_H2R = "ouadda", info_commune_H2R = "ouandja_kotto", info_loc_H2R = "yangou_samba")
data %>% filter(info_prefecture_H2R == "haute_kotto", info_sous_prefecture_H2R == "ouadda", info_commune_H2R == "ouandja_kotto", info_loc_H2R == "yangou_samba")
data %>% filter(info_prefecture_H2R == "haute_kotto", info_sous_prefecture_H2R == "ouadda", info_commune_H2R == "ouandja_kotto", info_loc_H2R == "yangou_samba") %>% select(ig_3_groupop.hote)
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data %>% group_by(group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R))%>% summarise(f = hsm_mode(ig_3_groupop.hote,type_contact))
data %>% group_by(group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R))%>% summarise(f = hsm_mode(ig_3_groupop.hote,type_contact))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R)
data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui,ig_3_groupop.hote)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui,"ig_3_groupop.hote")) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
#Reading data and form
data <- read_xlsx(CLEANED_DATASET, sheet = "Clean Data") %>% type_convert()
names(data)<-gsub("[/]",".",names(data))
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui,"ig_3_groupop.hote")) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data<-read_csv("./input/data.csv")
names(data)<-gsub("[/]",".",names(data))
data$ig_1_nb_pop
# Template dataset to merge at the end
template_data <- data[0,]
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data$ig_3_groupop.hote
data %>% filter(info_prefecture_H2R == "haute_kotto", info_sous_prefecture_H2R == "ouadda", info_commune_H2R == "ouandja_kotto", info_loc_H2R == "yangou_samba") %>% select(ig_3_groupop.hote)
data %>% filter(info_prefecture_H2R == "haute_kotto", info_sous_prefecture_H2R == "ouadda", info_commune_H2R == "ouandja_kotto", info_loc_H2R == "yangou_samba") %>% summarise(hsm_mode(ig_3_groupop.hote,"type_contact"))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data %>% filter(info_prefecture_H2R = "haut_mbomou", info_sous_prefecture_H2R = "bambouti", info_commune_H2R = "lili", info_loc_H2R = "autre") %>% summarise(hsm_mode(ig_3_groupop.hote,"type_contact"))
data %>% filter(info_prefecture_H2R == "haut_mbomou", info_sous_prefecture_H2R == "bambouti", info_commune_H2R == "lili", info_loc_H2R == "autre") %>% summarise(hsm_mode(ig_3_groupop.hote,"type_contact"))
data %>% filter(info_prefecture_H2R == "haute_kotto", info_sous_prefecture_H2R == "ouadda", info_commune_H2R == "ouandja_kotto", info_loc_H2R == "yangou_samba") %>% summarise(hsm_mode(ig_3_groupop.hote,"type_contact"))
data %>% mutate(var = c(replicate(1,nrow(data)-1),"AC"))
c(replicate(1,nrow(data)-1)
)
replicate(1,nrow(data)-1)
replicate(1,nrow(data))
data %>% mutate(var = c(replicate(nrow(data)-1,1),"AC"))
data %>% mutate(var = c(replicate(nrow(data)-1,1),"AC")) %>% select(var)
data %>% mutate(var = c("AC",replicate(nrow(data)-1,1))) %>% select(var)
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
as.character(2)
as.numeric("AC")
data %>% mutate(var = c("AC",replicate(nrow(data)-1,1))) %>% select(var)
data %>% mutate(var = c(1,replicate(nrow(data)-1,1))) %>% select(var)
formatC(1)
noquote(formatC(1))
hsm_mode <- function(x, type) {
x <- x[!is.na(x)]
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(table)
num_matches <- length(which(table == max_appearance))
if (num_matches > 1) {
tied <- ux[which(table == max_appearance)]
tied_visited <- integer(0)
for (i in 1:length(tied)) {
tied_visited[i] <- sum(type[x %in% tied[i]] %in% c("vit_localite", "visite_localite"))
}
if (sum(tied_visited == max(tied_visited)) == 1) {
return (tied[which.max(tied_visited)])
} else {
return("AC")
}
} else {
noquote(formatC(ux[which.max(table)]))
}
}
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
data$ig_2_chocpop
##### ADJUST ONLY THE CODE HERE ####
##### UNLESS THE TOOL HAS CHANGED ##
CLEANED_DATASET <- "input/car_hsm_data.xlsx"
hsm_mode <- function(x, type) {
x <- x[!is.na(x)]
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(table)
num_matches <- length(which(table == max_appearance))
if (num_matches > 1) {
tied <- ux[which(table == max_appearance)]
tied_visited <- integer(0)
for (i in 1:length(tied)) {
tied_visited[i] <- sum(type[x %in% tied[i]] %in% c("vit_localite", "visite_localite"))
}
if (sum(tied_visited == max(tied_visited)) == 1) {
return (tied[which.max(tied_visited)])
} else {
return("AC")
}
} else {
ux[which.max(table)]
}
}
#Reading data and form
data <- read_xlsx(CLEANED_DATASET, sheet = "Clean Data") %>% type_convert()
#Reading data and form
data <- read_xlsx(CLEANED_DATASET) %>% type_convert()
# Template dataset to merge at the end
template_data <- data[0,]
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
##### ADJUST ONLY THE CODE HERE ####
##### UNLESS THE TOOL HAS CHANGED ##
CLEANED_DATASET <- "input/car_hsm_data.xlsx"
AGGREGATED_DATASET <- "output/car_hsm_aggregated.csv"
hsm_preferred_response <- function(x, type, preferred_response) {
x <- x[!is.na(x)]
if (preferred_response %in% x[type %in% c("habite_localite", "visite_localite")]) {
return(preferred_response)
} else if (any(type %in% c("habite_localite", "visite_localite")) | sum(x %in% preferred_response) == 0) {
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(tabulate(match(x, ux)))
num_matches <- length(which(tabulate(match(x, ux)) == max_appearance))
if (num_matches > 1) {
if (sum(x %in% preferred_response) == max_appearance) {
return(preferred_response)
} else {
return("AC")
}
} else {
ux[which.max(tabulate(match(x, ux)))]
}
} else {
return(preferred_response)
}
}
hsm_mode <- function(x, type) {
x <- x[!is.na(x)]
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(table)
num_matches <- length(which(table == max_appearance))
if (num_matches > 1) {
tied <- ux[which(table == max_appearance)]
tied_visited <- integer(0)
for (i in 1:length(tied)) {
tied_visited[i] <- sum(type[x %in% tied[i]] %in% c("habite_localite", "visite_localite"))
}
if (sum(tied_visited == max(tied_visited)) == 1) {
return (tied[which.max(tied_visited)])
} else {
return("AC")
}
} else {
ux[which.max(table)]
}
}
#Reading data and form
# data <- read_csv(CLEANED_DATASET, col_types = cols(.default = "c"))
data <- read_xlsx(CLEANED_DATASET)
# Template dataset to merge at the end
template_data <- data[0,]
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
# Delete select_multiple text columns (not the binary/logical columns)
data <- data %>%
select(everything(), -strategie_survie)
# Questions that are always oui
ques_oui <- c("incident_mort", "incident_pillage","mineurs_separes" )
# Questions that are always non
ques_non <- c("sentiment_securite")
# Aggregating all questions
oui_localite_data <- data %>%
group_by(admin1_localite, admin2_localite, admin3_localite, nom_localite_renseigne) %>%
summarize_at(vars(ques_oui), ~hsm_preferred_response(., .data[["source_info_localite"]], "oui"))
non_localite_data <- data %>%
group_by(admin1_localite, admin2_localite, admin3_localite, nom_localite_renseigne) %>%
summarize_at(vars(ques_non), ~hsm_preferred_response(., .data[["source_info_localite"]], "non"))
autre_localite_data <- data %>%
group_by(admin1_localite, admin2_localite, admin3_localite, nom_localite_renseigne) %>%
select(large_deplacement_population:priorite_trois, -one_of(ques_oui, ques_non)) %>%
summarize_all(hsm_mode, .data[["source_info_localite"]])
autre_localite_data$provenance_dernier_retourne_sous_prefecture
autre_localite_data$`strategie_survie/reduire_depenses_nonalim`
data$`strategie_survie/reduire_depenses_nonalim`
rm(list = ls())
##### ADJUST ONLY THE CODE HERE ####
##### UNLESS THE TOOL HAS CHANGED ##
CLEANED_DATASET <- "input/CAR_MSNA2020_KI_H2R_dataset.xlsm"
AGGREGATED_DATASET <- "output/car_h2r_aggregated.csv"
# install.packages("readxl")
####################################
library(tidyverse)
library(readxl)
hsm_preferred_response <- function(x, type, preferred_response) {
x <- x[!is.na(x)]
if (preferred_response %in% x[type %in% c("vit_localite", "visite_localite")]) {
return(preferred_response)
} else if (any(type %in% c("vit_localite", "visite_localite")) | sum(x %in% preferred_response) == 0) {
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(tabulate(match(x, ux)))
num_matches <- length(which(tabulate(match(x, ux)) == max_appearance))
if (num_matches > 1) {
if (sum(x %in% preferred_response) == max_appearance) {
return(preferred_response)
} else {
return("AC")
}
} else {
ux[which.max(tabulate(match(x, ux)))]
}
} else {
return(preferred_response)
}
}
hsm_mode <- function(x, type) {
x <- x[!is.na(x)]
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(table)
num_matches <- length(which(table == max_appearance))
if (num_matches > 1) {
tied <- ux[which(table == max_appearance)]
tied_visited <- integer(0)
for (i in 1:length(tied)) {
tied_visited[i] <- sum(type[x %in% tied[i]] %in% c("vit_localite", "visite_localite"))
}
if (sum(tied_visited == max(tied_visited)) == 1) {
return (tied[which.max(tied_visited)])
} else {
return("AC")
}
} else {
ux[which.max(table)]
}
}
#Reading data and form
data <- read_xlsx(CLEANED_DATASET, sheet = "Clean Data")
data<-read_csv("./input/data.csv")
#Reading data and form
data <- read_xlsx(CLEANED_DATASET, sheet = "Clean Data")
names(data)<-gsub("[/]",".",names(data))
# Template dataset to merge at the end
template_data <- data[0,]
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
# Questions that are always oui
ques_oui <- c("protec_4_incident", "protec_6_kids_outHH_1",  "protec_6_kids_outHH_2" , "protec_6_kids_outHH_3",
"protec_6_kids_outHH_4" , "protec_6_kids_outHH_5" , "protec_6_kids_outHH_6" ,
"protec_6_kids_outHH_7",  "protec_6_kids_outHH_8" , "protec_6_kids_outHH_9" , "protec_6_kids_outHH_10")
# Aggregating all questions
oui_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
summarize_at(vars(ques_oui), ~hsm_preferred_response(., .data[["type_contact"]], "oui"))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
View(autre_localite_data)
View(autre_localite_data)
# Aggregating all data
localite_data <- oui_localite_data %>%
left_join(autre_localite_data, by = c("admin1_localite", "admin2_localite", "admin3_localite", "nom_localite_renseigne"))
# Aggregating all data
localite_data <- oui_localite_data %>%
left_join(autre_localite_data, by = c("info_prefecture_H2R", "info_sous_prefecture_H2R", "info_commune_H2R", "info_loc_H2R"))
'%!in%' = Negate('%in%')
localite_data <- localite_data %>%
mutate(ig_2_chocpop_why = ifelse(ig_2_chocpop == "oui", ig_2_chocpop_why, NA),
ig_3_groupop_pourcentage_1 = ifelse(ig_3_groupop == "hote", ig_3_groupop_pourcentage_1, NA),
ig_3_groupop_pourcentage_2 = ifelse(ig_3_groupop == "IDP_site", ig_3_groupop_pourcentage_2, NA),
ig_3_groupop_pourcentage_3 = ifelse(ig_3_groupop == "IDP_FA", ig_3_groupop_pourcentage_3, NA),
ig_3_groupop_pourcentage_4 = ifelse(ig_3_groupop == "retourne", ig_3_groupop_pourcentage_4, NA),
ig_3_groupop_pourcentage_5 = ifelse(ig_3_groupop == "rapatrie", ig_3_groupop_pourcentage_5, NA),
ig_4_raison_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_4_raison_idp, NA),
ig_5_choix_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_5_choix_idp, NA),
ig_6_duree_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_6_duree_idp, NA),
ig_7_raisonretour_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_7_raisonretour_idp, NA),
ig_8_raison_ret_rapat = ifelse(ig_3_groupop == "retourne"|ig_3_groupop == "rapatrie", ig_8_raison_ret_rap, NA),
ig_9_destinationfinale_perc = ifelse(ig_3_groupop == "retourne"|ig_3_groupop == "rapatrie", ig_9_destinationfinale_perc, NA),
ig_10_destinationfinale_raison = ifelse(ig_3_groupop %in% c("retourne","rapatrie") & ig_9_destinationfinale_perc != 'ret_rap_destfinale_0', ig_10_destinationfinale_raison, NA),
abri_2_pourcentage_1 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_dur_finie", abri_2_pourcentage_1, NA),
abri_2_pourcentage_2 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_dur_non_finie", abri_2_pourcentage_2, NA),
abri_2_pourcentage_3 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_semi_dur", abri_2_pourcentage_3, NA),
abri_2_pourcentage_4 = ifelse(abri_1_type != "nsp" & abri_1_type == "habitat_paille", abri_2_pourcentage_4, NA),
abri_2_pourcentage_5 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_collectif", abri_2_pourcentage_5, NA),
abri_2_pourcentage_6 = ifelse(abri_1_type != "nsp" & abri_1_type == "tente", abri_2_pourcentage_6, NA),
abri_2_pourcentage_7 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_urgence_bache", abri_2_pourcentage_7, NA),
abri_2_pourcentage_8 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_urgence_paille", abri_2_pourcentage_8, NA),
abri_2_pourcentage_9 = ifelse(abri_1_type != "nsp" & abri_1_type == "aucun", abri_2_pourcentage_9, NA),
abri_2_pourcentage_10 = ifelse(abri_1_type != "nsp" & abri_1_type == "autre", abri_2_pourcentage_10, NA),
abri_4_problem_2 = ifelse(abri_4_problem_1 %!in% c("nsp","aucun"), abri_4_problem_2, NA),
abri_4_problem_3 = ifelse(abri_4_problem_1 %!in% c("nsp","aucun") & abri_4_problem_2 %!in% c("nsp","aucun"), abri_4_problem_3, NA),
abri_5_damage_2 = ifelse(abri_5_damage_1 %!in% c("nsp","aucun"), abri_5_damage_2, NA),
abri_5_damage_3 =ifelse(abri_5_damage_1 %!in% c("nsp","aucun") & abri_5_damage_2 %!in% c("nsp","aucun"), abri_5_damage_3, NA),
sante_1_1_maternite = ifelse(sante_1_maternite == "maison", sante_1_1_maternite, NA),
sante_1_2_maternite = ifelse(sante_1_maternite == "maison" & sante_1_1_maternite != "nsp", sante_1_2_maternite, NA),
sante_1_3_maternite = ifelse(sante_1_maternite == "maison" & sante_1_1_maternite != "nsp" & sante_1_2_maternite != "nsp", sante_1_3_maternite, NA),
sante_2_diff_soin_2 = ifelse(sante_2_diff_soin_1 %!in% c("nsp","aucun"), sante_2_diff_soin_2, NA),
sante_2_diff_soin_3 = ifelse(sante_2_diff_soin_1 %!in% c("nsp","aucun") & sante_2_diff_soin_2 %!in% c("nsp","aucun"), sante_2_diff_soin_3, NA),
sante_6_deces_2 = ifelse(sante_6_deces_1 != "nsp", sante_6_deces_2, NA),
sante_6_deces_3 = ifelse(sante_6_deces_1 != "nsp" & sante_6_deces_2 != "nsp", sante_6_deces_3, NA),
secal_2_income_source_2 = ifelse(secal_2_income_source_1 != "nsp", secal_2_income_source_2, NA),
secal_2_income_source_3 = ifelse(secal_2_income_source_1 != "nsp" & secal_2_income_source_2 != "nsp", secal_2_income_source_3, NA),
secal_4_agri_diff_2 = ifelse(secal_4_agri_diff_1 != "nsp", secal_4_agri_diff_2, NA),
secal_4_agri_diff_3 = ifelse(secal_4_agri_diff_1 != "nsp" & secal_4_agri_diff_2 != "nsp", secal_4_agri_diff_3, NA),
mssc_1_foodsource_2 = ifelse(mssc_1_foodsource_1 != "nsp", mssc_1_foodsource_2, NA),
mssc_1_foodsource_3 = ifelse(mssc_1_foodsource_1 != "nsp" & mssc_1_foodsource_2 != "nsp", mssc_1_foodsource_3, NA),
mssc_4_marketappro_2 = ifelse(mssc_4_marketappro_1 %!in% c("nsp","aucun"), mssc_4_marketappro_2, NA),
mssc_4_marketappro_3 = ifelse(mssc_4_marketappro_1 %!in% c("nsp","aucun") & mssc_4_marketappro_2 %!in% c("nsp","aucun"), mssc_4_marketappro_3, NA),
nut_4_diff_soin_2 = ifelse(nut_4_diff_soin_1 %!in% c("nsp","aucun"), nut_4_diff_soin_2, NA),
nut_4_diff_soin_3 = ifelse(nut_4_diff_soin_1 %!in% c("nsp","aucun") & nut_4_diff_soin_2 %!in% c("nsp","aucun"), nut_4_diff_soin_3, NA),
wash_4_diff_eau_2 = ifelse(wash_4_diff_eau_1 %!in% c("nsp","aucun"), wash_4_diff_eau_2, NA),
wash_4_diff_eau_3 = ifelse(wash_4_diff_eau_1 %!in% c("nsp","aucun") & wash_4_diff_eau_2 %!in% c("nsp","aucun"), wash_4_diff_eau_3, NA),
wash_7_genre = ifelse(wash_6_infra_20p == "oui", wash_7_genre, NA),
wash_8_diff_infra_2 = ifelse(wash_8_diff_infra_1 %!in% c("nsp","aucun"), wash_8_diff_infra_2, NA),
wash_8_diff_infra_3 = ifelse(wash_8_diff_infra_1 %!in% c("nsp","aucun") & wash_8_diff_infra_2 %!in% c("nsp","aucun"), wash_8_diff_infra_3, NA),
protec_2_secu_ad_hommes = ifelse(protec_2_secu_ad == "oui", protec_2_secu_ad_hommes, NA),
protec_2_secu_ad_femmes = ifelse(protec_2_secu_ad == "oui", protec_2_secu_ad_femmes, NA),
protec_3_secu_kid_garcons = ifelse(protec_3_secu_kid == "oui", protec_3_secu_kid_garcons, NA),
protec_3_secu_kid_filles = ifelse(protec_3_secu_kid == "oui", protec_3_secu_kid_filles, NA),
protec_4_incident_type_2 = ifelse(protec_4_incident_type_1 %!in% c("nsp","aucun"), protec_4_incident_type_2, NA),
protec_4_incident_type_3 = ifelse(protec_4_incident_type_1 %!in% c("nsp","aucun") & protec_4_incident_type_2 %!in% c("nsp","aucun"), protec_4_incident_type_3, NA),
protec_5_travailforce_type = ifelse(protec_5_travailforce == "oui", protec_5_travailforce_type, NA),
aap_2_goodaide = ifelse(aap_1_aide == "oui", aap_2_goodaide, NA),
aap_4_typeinfos_2 = ifelse(aap_4_typeinfos_1 != "nsp", aap_4_typeinfos_2, NA),
aap_4_typeinfos_3 = ifelse(aap_4_typeinfos_1 != "nsp" & aap_4_typeinfos_2 != "nsp", aap_4_typeinfos_3, NA))
final_data <- bind_rows(template_data, localite_data)
# write_csv(final_data, AGGREGATED_DATASET, na = "")
write.csv(final_data, AGGREGATED_DATASET, na = "")
rm(list = ls())
##### ADJUST ONLY THE CODE HERE ####
##### UNLESS THE TOOL HAS CHANGED ##
CLEANED_DATASET <- "input/CAR_MSNA2020_KI_H2R_dataset.xlsm"
AGGREGATED_DATASET <- "output/car_msna_ki_aggregated.csv"
# install.packages("readxl")
####################################
library(tidyverse)
library(readxl)
hsm_preferred_response <- function(x, type, preferred_response) {
x <- x[!is.na(x)]
if (preferred_response %in% x[type %in% c("vit_localite", "visite_localite")]) {
return(preferred_response)
} else if (any(type %in% c("vit_localite", "visite_localite")) | sum(x %in% preferred_response) == 0) {
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(tabulate(match(x, ux)))
num_matches <- length(which(tabulate(match(x, ux)) == max_appearance))
if (num_matches > 1) {
if (sum(x %in% preferred_response) == max_appearance) {
return(preferred_response)
} else {
return("AC")
}
} else {
ux[which.max(tabulate(match(x, ux)))]
}
} else {
return(preferred_response)
}
}
hsm_mode <- function(x, type) {
x <- x[!is.na(x)]
ux <- unique(x)
table <- tabulate(match(x, ux))
max_appearance <- max(table)
num_matches <- length(which(table == max_appearance))
if (num_matches > 1) {
tied <- ux[which(table == max_appearance)]
tied_visited <- integer(0)
for (i in 1:length(tied)) {
tied_visited[i] <- sum(type[x %in% tied[i]] %in% c("vit_localite", "visite_localite"))
}
if (sum(tied_visited == max(tied_visited)) == 1) {
return (tied[which.max(tied_visited)])
} else {
return("AC")
}
} else {
ux[which.max(table)]
}
}
'%!in%' = Negate('%in%')
#Reading data and form
data <- read_xlsx(CLEANED_DATASET, sheet = "Clean Data")
names(data)<-gsub("[/]",".",names(data))
# Template dataset to merge at the end
template_data <- data[0,]
# Remove other questions
data <- data %>%
select(everything(), -ends_with("_autre"))
# Questions that are always oui
ques_oui <- c("protec_4_incident", "protec_6_kids_outHH_1",  "protec_6_kids_outHH_2" , "protec_6_kids_outHH_3",
"protec_6_kids_outHH_4" , "protec_6_kids_outHH_5" , "protec_6_kids_outHH_6" ,
"protec_6_kids_outHH_7",  "protec_6_kids_outHH_8" , "protec_6_kids_outHH_9" , "protec_6_kids_outHH_10")
# Aggregating all questions
oui_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
summarize_at(vars(ques_oui), ~hsm_preferred_response(., .data[["type_contact"]], "oui"))
autre_localite_data <- data %>%
group_by(info_prefecture_H2R, info_sous_prefecture_H2R, info_commune_H2R, info_loc_H2R) %>%
select(ig_2_chocpop:aap_6_retouraide, -one_of(ques_oui)) %>%
summarize_all(hsm_mode, .data[["type_contact"]])
# Aggregating all data
localite_data <- oui_localite_data %>%
left_join(autre_localite_data, by = c("info_prefecture_H2R", "info_sous_prefecture_H2R", "info_commune_H2R", "info_loc_H2R"))
localite_data <- localite_data %>%
mutate(ig_2_chocpop_why = ifelse(ig_2_chocpop == "oui", ig_2_chocpop_why, NA),
ig_3_groupop_pourcentage_1 = ifelse(ig_3_groupop == "hote", ig_3_groupop_pourcentage_1, NA),
ig_3_groupop_pourcentage_2 = ifelse(ig_3_groupop == "IDP_site", ig_3_groupop_pourcentage_2, NA),
ig_3_groupop_pourcentage_3 = ifelse(ig_3_groupop == "IDP_FA", ig_3_groupop_pourcentage_3, NA),
ig_3_groupop_pourcentage_4 = ifelse(ig_3_groupop == "retourne", ig_3_groupop_pourcentage_4, NA),
ig_3_groupop_pourcentage_5 = ifelse(ig_3_groupop == "rapatrie", ig_3_groupop_pourcentage_5, NA),
ig_4_raison_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_4_raison_idp, NA),
ig_5_choix_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_5_choix_idp, NA),
ig_6_duree_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_6_duree_idp, NA),
ig_7_raisonretour_idp = ifelse(ig_3_groupop == "IDP_site"|ig_3_groupop == "IDP_FA", ig_7_raisonretour_idp, NA),
ig_8_raison_ret_rapat = ifelse(ig_3_groupop == "retourne"|ig_3_groupop == "rapatrie", ig_8_raison_ret_rap, NA),
ig_9_destinationfinale_perc = ifelse(ig_3_groupop == "retourne"|ig_3_groupop == "rapatrie", ig_9_destinationfinale_perc, NA),
ig_10_destinationfinale_raison = ifelse(ig_3_groupop %in% c("retourne","rapatrie") & ig_9_destinationfinale_perc != 'ret_rap_destfinale_0', ig_10_destinationfinale_raison, NA),
abri_2_pourcentage_1 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_dur_finie", abri_2_pourcentage_1, NA),
abri_2_pourcentage_2 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_dur_non_finie", abri_2_pourcentage_2, NA),
abri_2_pourcentage_3 = ifelse(abri_1_type != "nsp" & abri_1_type == "maison_semi_dur", abri_2_pourcentage_3, NA),
abri_2_pourcentage_4 = ifelse(abri_1_type != "nsp" & abri_1_type == "habitat_paille", abri_2_pourcentage_4, NA),
abri_2_pourcentage_5 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_collectif", abri_2_pourcentage_5, NA),
abri_2_pourcentage_6 = ifelse(abri_1_type != "nsp" & abri_1_type == "tente", abri_2_pourcentage_6, NA),
abri_2_pourcentage_7 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_urgence_bache", abri_2_pourcentage_7, NA),
abri_2_pourcentage_8 = ifelse(abri_1_type != "nsp" & abri_1_type == "abri_urgence_paille", abri_2_pourcentage_8, NA),
abri_2_pourcentage_9 = ifelse(abri_1_type != "nsp" & abri_1_type == "aucun", abri_2_pourcentage_9, NA),
abri_2_pourcentage_10 = ifelse(abri_1_type != "nsp" & abri_1_type == "autre", abri_2_pourcentage_10, NA),
abri_4_problem_2 = ifelse(abri_4_problem_1 %!in% c("nsp","aucun"), abri_4_problem_2, NA),
abri_4_problem_3 = ifelse(abri_4_problem_1 %!in% c("nsp","aucun") & abri_4_problem_2 %!in% c("nsp","aucun"), abri_4_problem_3, NA),
abri_5_damage_2 = ifelse(abri_5_damage_1 %!in% c("nsp","aucun"), abri_5_damage_2, NA),
abri_5_damage_3 =ifelse(abri_5_damage_1 %!in% c("nsp","aucun") & abri_5_damage_2 %!in% c("nsp","aucun"), abri_5_damage_3, NA),
sante_1_1_maternite = ifelse(sante_1_maternite == "maison", sante_1_1_maternite, NA),
sante_1_2_maternite = ifelse(sante_1_maternite == "maison" & sante_1_1_maternite != "nsp", sante_1_2_maternite, NA),
sante_1_3_maternite = ifelse(sante_1_maternite == "maison" & sante_1_1_maternite != "nsp" & sante_1_2_maternite != "nsp", sante_1_3_maternite, NA),
sante_2_diff_soin_2 = ifelse(sante_2_diff_soin_1 %!in% c("nsp","aucun"), sante_2_diff_soin_2, NA),
sante_2_diff_soin_3 = ifelse(sante_2_diff_soin_1 %!in% c("nsp","aucun") & sante_2_diff_soin_2 %!in% c("nsp","aucun"), sante_2_diff_soin_3, NA),
sante_6_deces_2 = ifelse(sante_6_deces_1 != "nsp", sante_6_deces_2, NA),
sante_6_deces_3 = ifelse(sante_6_deces_1 != "nsp" & sante_6_deces_2 != "nsp", sante_6_deces_3, NA),
secal_2_income_source_2 = ifelse(secal_2_income_source_1 != "nsp", secal_2_income_source_2, NA),
secal_2_income_source_3 = ifelse(secal_2_income_source_1 != "nsp" & secal_2_income_source_2 != "nsp", secal_2_income_source_3, NA),
secal_4_agri_diff_2 = ifelse(secal_4_agri_diff_1 != "nsp", secal_4_agri_diff_2, NA),
secal_4_agri_diff_3 = ifelse(secal_4_agri_diff_1 != "nsp" & secal_4_agri_diff_2 != "nsp", secal_4_agri_diff_3, NA),
mssc_1_foodsource_2 = ifelse(mssc_1_foodsource_1 != "nsp", mssc_1_foodsource_2, NA),
mssc_1_foodsource_3 = ifelse(mssc_1_foodsource_1 != "nsp" & mssc_1_foodsource_2 != "nsp", mssc_1_foodsource_3, NA),
mssc_4_marketappro_2 = ifelse(mssc_4_marketappro_1 %!in% c("nsp","aucun"), mssc_4_marketappro_2, NA),
mssc_4_marketappro_3 = ifelse(mssc_4_marketappro_1 %!in% c("nsp","aucun") & mssc_4_marketappro_2 %!in% c("nsp","aucun"), mssc_4_marketappro_3, NA),
nut_4_diff_soin_2 = ifelse(nut_4_diff_soin_1 %!in% c("nsp","aucun"), nut_4_diff_soin_2, NA),
nut_4_diff_soin_3 = ifelse(nut_4_diff_soin_1 %!in% c("nsp","aucun") & nut_4_diff_soin_2 %!in% c("nsp","aucun"), nut_4_diff_soin_3, NA),
wash_4_diff_eau_2 = ifelse(wash_4_diff_eau_1 %!in% c("nsp","aucun"), wash_4_diff_eau_2, NA),
wash_4_diff_eau_3 = ifelse(wash_4_diff_eau_1 %!in% c("nsp","aucun") & wash_4_diff_eau_2 %!in% c("nsp","aucun"), wash_4_diff_eau_3, NA),
wash_7_genre = ifelse(wash_6_infra_20p == "oui", wash_7_genre, NA),
wash_8_diff_infra_2 = ifelse(wash_8_diff_infra_1 %!in% c("nsp","aucun"), wash_8_diff_infra_2, NA),
wash_8_diff_infra_3 = ifelse(wash_8_diff_infra_1 %!in% c("nsp","aucun") & wash_8_diff_infra_2 %!in% c("nsp","aucun"), wash_8_diff_infra_3, NA),
protec_2_secu_ad_hommes = ifelse(protec_2_secu_ad == "oui", protec_2_secu_ad_hommes, NA),
protec_2_secu_ad_femmes = ifelse(protec_2_secu_ad == "oui", protec_2_secu_ad_femmes, NA),
protec_3_secu_kid_garcons = ifelse(protec_3_secu_kid == "oui", protec_3_secu_kid_garcons, NA),
protec_3_secu_kid_filles = ifelse(protec_3_secu_kid == "oui", protec_3_secu_kid_filles, NA),
protec_4_incident_type_2 = ifelse(protec_4_incident_type_1 %!in% c("nsp","aucun"), protec_4_incident_type_2, NA),
protec_4_incident_type_3 = ifelse(protec_4_incident_type_1 %!in% c("nsp","aucun") & protec_4_incident_type_2 %!in% c("nsp","aucun"), protec_4_incident_type_3, NA),
protec_5_travailforce_type = ifelse(protec_5_travailforce == "oui", protec_5_travailforce_type, NA),
aap_2_goodaide = ifelse(aap_1_aide == "oui", aap_2_goodaide, NA),
aap_4_typeinfos_2 = ifelse(aap_4_typeinfos_1 != "nsp", aap_4_typeinfos_2, NA),
aap_4_typeinfos_3 = ifelse(aap_4_typeinfos_1 != "nsp" & aap_4_typeinfos_2 != "nsp", aap_4_typeinfos_3, NA))
final_data <- bind_rows(template_data, localite_data)
# write_csv(final_data, AGGREGATED_DATASET, na = "")
write.csv(final_data, AGGREGATED_DATASET, na = "")
